{"version":3,"sources":["../../src/routes/updatePlayerBalances.js"],"names":["router","Router","use","get","authenticate","session","req","res","thisWeeklyBalance","thisWeekWonAmount","thisWeekLossAmount","currentOpenBetAmount","find","playerUsername","user","username","finalConfirmTimePST","$gt","startOf","unix","$lt","endOf","err","result","length","map","history","historyIdx","wagerResult","event","WagerDetail","estWinAmount","estRiskAmount","openBet","openBetIdx","console","log","Number","weeklyBalance","findOneAndUpdate","thisWeekBalance","new","json","latestPlayerStatus","passcode","undefined"],"mappings":";;;;;;AAAA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;;;AATA,IAAMA,SAAS,kBAAQC,MAAR,EAAf;;;AAWA,mBAASC,GAAT;;AAEAF,OAAOG,GAAP,CAAW,yBAAX,EAAsC,mBAASC,YAAT,CAAsB,KAAtB,EAA6B,EAACC,SAAS,KAAV,EAA7B,CAAtC,EAAsF,UAASC,GAAT,EAAcC,GAAd,EAAkB;AACvG,KAAIC,oBAAoB,CAAxB;AACA,KAAIC,oBAAoB,CAAxB;AACA,KAAIC,qBAAqB,CAAzB;AACA,KAAIC,uBAAuB,CAA3B;;AAEA,kCAAuBC,IAAvB,CAA4B,EAACC,gBAAgBP,IAAIQ,IAAJ,CAASC,QAA1B,EAAoCC,qBAAqB,EAAEC,KAAK,wBAASC,OAAT,CAAiB,MAAjB,EAAyBC,IAAzB,EAAP,EAAwCC,KAAK,wBAASC,KAAT,CAAe,MAAf,EAAuBF,IAAvB,EAA7C,EAAzD,EAA5B,EAAoK,UAASG,GAAT,EAAcC,MAAd,EAAqB;AACxL,MAAGA,OAAOC,MAAP,GAAgB,CAAnB,EAAqB;AACpBD,UAAOE,GAAP,CAAW,UAASC,OAAT,EAAkBC,UAAlB,EAA6B;AACvC,YAAOD,QAAQE,WAAf;AACC,UAAK,KAAL;AACCnB,2BAAqBiB,QAAQG,KAAR,CAAcC,WAAd,CAA0BC,YAA/C;AACA;AACD,UAAK,MAAL;AACCrB,4BAAsBgB,QAAQG,KAAR,CAAcC,WAAd,CAA0BE,aAAhD;AACD;AACC;AAPF;AASA,IAVD;AAWA;;AAED,iCAAqBpB,IAArB,CAA0B,EAACC,gBAAgBP,IAAIQ,IAAJ,CAASC,QAA1B,EAA1B,EAA+D,UAASO,GAAT,EAAcC,MAAd,EAAqB;AACnF,OAAGA,OAAOC,MAAP,GAAgB,CAAnB,EAAqB;AACpBD,WAAOE,GAAP,CAAW,UAASQ,OAAT,EAAkBC,UAAlB,EAA6B;AACvCC,aAAQC,GAAR,CAAYzB,oBAAZ;AACAA,6BAAwB0B,OAAOJ,QAAQJ,KAAR,CAAcC,WAAd,CAA0BE,aAAjC,CAAxB;AACA,KAHD;AAIA;;AAEDxB,uBAAoBF,IAAIQ,IAAJ,CAASwB,aAAT,GAAyB7B,iBAAzB,GAA6CC,kBAA7C,GAAkEC,oBAAtF;AACA,kBAAK4B,gBAAL,CAAsB,EAACxB,UAAUT,IAAIQ,IAAJ,CAASC,QAApB,EAAtB,EACC,EAAE,QAAQ;AACTJ,2BAAsBA,oBADb;AAET6B,sBAAiBhC,iBAFR;AAGTC,wBAAmBA,iBAHV;AAITC,yBAAoBA;AAJX,KAAV,EADD,EAOG,EAAC+B,KAAK,IAAN,EAPH,EAOgB,UAASnB,GAAT,EAAcC,MAAd,EAAqB;;AAEpChB,QAAImC,IAAJ,CAASnB,MAAT;AACA,IAVD;AAWA,GApBD;AAqBA,EApCD;AA0CA,CAhDD;;AAmDAvB,OAAOG,GAAP,CAAW,uBAAX,EAAoC,mBAASC,YAAT,CAAsB,KAAtB,EAA6B,EAACC,SAAS,KAAV,EAA7B,CAApC,EAAoF,UAACC,GAAD,EAAMC,GAAN,EAAc;AACjG,gBAAKK,IAAL,CAAU,EAACG,UAAUT,IAAIQ,IAAJ,CAASC,QAApB,EAAV,EAAyC,qPAAzC,EAA+R,UAASO,GAAT,EAAcC,MAAd,EAAqB;AACnT,MAAIoB,qBAAqBpB,OAAO,CAAP,CAAzB;AACAoB,qBAAmBC,QAAnB,GAA8BC,SAA9B;;AAEAtC,MAAImC,IAAJ,CAASC,kBAAT;AACA,EALD;AAMA,CAPD;;kBAUe3C,M;;AAKf;AACA;AACA;;;AAGC;;AAEA","file":"updatePlayerBalances.js","sourcesContent":["import express from 'express';\nconst router = express.Router();\nimport fetch from 'node-fetch';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport StraightOpenBetWager from '../models/StraightOpenBetWager';\nimport StraightBetWagerResult from '../models/StraightBetWagerResult';\nimport User from '../models/User';\n\nimport JwtStrategy from '../middleware/JwtStrategy';\nimport passport from \"passport\";\n\npassport.use(JwtStrategy);\n\nrouter.get('/update-player-balances', passport.authenticate('jwt', {session: false}), function(req, res){\n\tlet thisWeeklyBalance = 0;\n\tlet thisWeekWonAmount = 0;\n\tlet thisWeekLossAmount = 0;\n\tlet currentOpenBetAmount = 0;\n\n\tStraightBetWagerResult.find({playerUsername: req.user.username, finalConfirmTimePST: { $gt: moment().startOf('week').unix(), $lt: moment().endOf('week').unix() }}, function(err, result){\n\t\tif(result.length > 0){\n\t\t\tresult.map(function(history, historyIdx){\n\t\t\t\tswitch(history.wagerResult){\n\t\t\t\t\tcase 'won':\n\t\t\t\t\t\tthisWeekWonAmount += history.event.WagerDetail.estWinAmount;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'loss':\n\t\t\t\t\t\tthisWeekLossAmount -= history.event.WagerDetail.estRiskAmount;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\tStraightOpenBetWager.find({playerUsername: req.user.username}, function(err, result){\n\t\t\tif(result.length > 0){\n\t\t\t\tresult.map(function(openBet, openBetIdx){\n\t\t\t\t\tconsole.log(currentOpenBetAmount)\n\t\t\t\t\tcurrentOpenBetAmount += Number(openBet.event.WagerDetail.estRiskAmount)\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tthisWeeklyBalance = req.user.weeklyBalance + thisWeekWonAmount + thisWeekLossAmount - currentOpenBetAmount\n\t\t\tUser.findOneAndUpdate({username: req.user.username}, \n\t\t\t\t{ '$set': { \n\t\t\t\t\tcurrentOpenBetAmount: currentOpenBetAmount,\n\t\t\t\t\tthisWeekBalance: thisWeeklyBalance, \n\t\t\t\t\tthisWeekWonAmount: thisWeekWonAmount,\n\t\t\t\t\tthisWeekLossAmount: thisWeekLossAmount\n\t\t\t\t} }\n\t\t\t\t, {new: true}, function(err, result){\n\n\t\t\t\tres.json(result)\n\t\t\t})\n\t\t})\n\t})\n\n\n\n\n\n})\n\n\nrouter.get('/update-player-status', passport.authenticate('jwt', {session: false}), (req, res) => {\n\tUser.find({username: req.user.username}, 'userStatus username passcode agent superAgent email phoneNumber minBetAmount maxBetAmount maxWinAmount weeklyBalance thisWeekBalance thisWeekLossAmount thisWeekWonAmount lastWeekBalance lastWeekLossAmount lastWeekWonAmount currentOpenBetAmount',function(err, result){\n\t\tlet latestPlayerStatus = result[0]\n\t\tlatestPlayerStatus.passcode = undefined\n\n\t\tres.json(latestPlayerStatus)\n\t})\n})\n\n\nexport default router\n\n\n\n\n//console.log(moment().startOf('week').subtract(7, 'days'))\n// console.log(moment().startOf('week'))\n// console.log(moment().endOf('week'))\n\n\n\t// User.findOneAndUpdate({username: req.body.username}, function(err, result){\n\n\t// })"]}